// Generated by CoffeeScript 1.8.0
(function() {
  var App, ArchiveDisplayer, ArchiveHelper, ArchiveList, ArchiveListItem, ContextMenu, CubeLoadingHint, Flag, List, ListArchiveDisplayer, ListItem, ListScene, Model, Scene, ScrollChecker, SwipeChecker, moment, tm,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  App = require("/app");

  SwipeChecker = require("/component/swipeChecker");

  Model = App.Model;

  Scene = require("/view/base/scene");

  ArchiveDisplayer = require("/view/base/archiveDisplayer");

  ScrollChecker = require("/component/scrollChecker");

  CubeLoadingHint = require("/widget/cubeLoadingHint");

  ContextMenu = require("/widget/contextMenu");

  moment = require("/component/moment");

  tm = require("/common/templateManager");

  tm.use("view/listScene/scene");

  ListScene = (function(_super) {
    __extends(ListScene, _super);

    function ListScene() {
      var checker;
      this.list = new List(this);
      this.archives = new ArchiveList(this);
      this.archiveDisplayer = new ListArchiveDisplayer(this);
      this.list.on("init", (function(_this) {
        return function() {
          if (_this.isShow) {
            return _this.show();
          }
        };
      })(this));
      this.list.on("select", (function(_this) {
        return function(list) {
          _this.archives.load(list.archiveList);
          return _this.slideTo(1);
        };
      })(this));
      this.archives.on("archive", (function(_this) {
        return function() {
          console.debug("slide to 1");
          return _this.slideTo(1);
        };
      })(this));
      this.archives.on("select", (function(_this) {
        return function(archiveListItem) {
          _this.archiveDisplayer.display(archiveListItem.archive);
          _this.archiveDisplayer.maybeList = archiveListItem.listName;
          if (_this.currentArchiveListItem) {
            _this.currentArchiveListItem.deselect();
          }
          _this.currentArchiveListItem = archiveListItem;
          _this.slideTo(2);
          return _this.enableArchiveAutoSlide = true;
        };
      })(this));
      ListScene.__super__.constructor.call(this, App.templates.view.listScene.scene, "list scene");
      checker = new SwipeChecker(this.node);
      checker.on("swiperight", (function(_this) {
        return function(ev) {
          return _this.previousSlide();
        };
      })(this));
      checker.on("swipeleft", (function(_this) {
        return function(ev) {
          return _this.nextSlide();
        };
      })(this));
      this.currentSlide = 0;
    }

    ListScene.prototype.slideTo = function(count) {
      if (count < 0) {
        count = 0;
      }
      if (count > 2) {
        count = 2;
      }
      this.currentSlide = count;
      return this.applySlide();
    };

    ListScene.prototype.nextSlide = function() {
      return this.slideTo(this.currentSlide + 1 || 2);
    };

    ListScene.prototype.previousSlide = function() {
      if (this.currentSlide <= 0) {
        return;
      }
      return this.slideTo(this.currentSlide - 1 || 0);
    };

    ListScene.prototype.applySlide = function() {
      if (this.currentSlide === 0) {
        return this.node$.removeClass("slide-col2").removeClass("slide-col3");
      } else if (this.currentSlide === 1) {
        return this.node$.addClass("slide-col2").removeClass("slide-col3");
      } else if (this.currentSlide === 2) {
        if (!this.archiveDisplayer.archive) {
          return;
        }
        return this.node$.addClass("slide-col2").addClass("slide-col3");
      }
    };

    ListScene.prototype.show = function() {
      if (!this.list.current && this.list.lists.length > 0) {
        this.list.lists[0].select();
      }
      return ListScene.__super__.show.call(this);
    };

    return ListScene;

  })(Scene);

  tm.use("view/listScene/listSceneList");

  List = (function(_super) {
    __extends(List, _super);

    function List(context) {
      this.context = context;
      List.__super__.constructor.call(this, App.templates.view.listScene.listSceneList);
      this.lists = Leaf.Widget.makeList(this.UI.container);
      App.afterInitialLoad((function(_this) {
        return function() {
          return Model.ArchiveList.sync(function() {
            return _this.emit("init");
          });
        };
      })(this));
      App.modelSyncManager.on("archiveList/remove", (function(_this) {
        return function(list) {
          var index, item, _i, _len, _ref, _results;
          _ref = _this.lists;
          _results = [];
          for (index = _i = 0, _len = _ref.length; _i < _len; index = ++_i) {
            item = _ref[index];
            if (item.archiveList.name === list.name) {
              _this.lists.splice(index, 1);
              break;
            } else {
              _results.push(void 0);
            }
          }
          return _results;
        };
      })(this));
      App.modelSyncManager.on("archiveList/add", (function(_this) {
        return function(list) {
          return _this.lists.push(new ListItem(list));
        };
      })(this));
      this.lists.on("child/add", (function(_this) {
        return function(list) {
          return _this.bubble(list, "select", function() {
            if (this.current) {
              this.current.node$.removeClass("select");
            }
            this.current = list;
            return ["select", list];
          });
        };
      })(this));
    }

    List.prototype.onClickAddListButton = function() {
      var name;
      name = prompt("enter you list name");
      if (!name || !name.trim()) {
        return;
      }
      name = name.trim();
      return Model.ArchiveList.create(name, (function(_this) {
        return function(err, list) {
          console.debug("create list", err, list);
          if (err) {
            return App.showError(err);
          }
        };
      })(this));
    };

    return List;

  })(Leaf.Widget);

  tm.use("view/listScene/listSceneListItem");

  ListItem = (function(_super) {
    __extends(ListItem, _super);

    function ListItem(archiveList) {
      this.archiveList = archiveList;
      this.onClickNode = __bind(this.onClickNode, this);
      ListItem.__super__.constructor.call(this, App.templates.view.listScene.listSceneListItem);
      this.archiveList.on("add", (function(_this) {
        return function(archive) {
          return _this.render();
        };
      })(this));
      this.archiveList.on("remove", (function(_this) {
        return function(archive) {
          return _this.render();
        };
      })(this));
      this.archiveList.on("change", (function(_this) {
        return function() {
          return _this.render();
        };
      })(this));
      this.render();
      this.node.oncontextmenu = (function(_this) {
        return function(e) {
          e.preventDefault();
          e.stopImmediatePropagation();
          if (_this.contextMenu == null) {
            _this.contextMenu = new ContextMenu([
              {
                name: "remove list",
                callback: _this.removeList.bind(_this)
              }
            ]);
          }
          return _this.contextMenu.show(e);
        };
      })(this);
    }

    ListItem.prototype.removeList = function() {
      return this.archiveList["delete"](function() {
        return console.log("delete?");
      });
    };

    ListItem.prototype.render = function() {
      this.UI.name$.text(this.archiveList.name);
      this.UI.unreadCounter$.text(this.archiveList.count);
      return this.name = this.archiveList.name;
    };

    ListItem.prototype.select = function() {
      this.emit("select", this);
      return this.node$.addClass("select");
    };

    ListItem.prototype.onClickNode = function(e) {
      return this.select();
    };

    return ListItem;

  })(Leaf.Widget);

  tm.use("view/listScene/listSceneArchiveList");

  ArchiveList = (function(_super) {
    __extends(ArchiveList, _super);

    function ArchiveList(context) {
      this.context = context;
      this.include(CubeLoadingHint);
      ArchiveList.__super__.constructor.call(this, App.templates.view.listScene.listSceneArchiveList);
      this.archives = Leaf.Widget.makeList(this.UI.archives);
      this.archives.on("child/add", (function(_this) {
        return function(archiveListItem) {
          archiveListItem.listName = _this.currentList.name;
          return archiveListItem.listenBy(_this, "select", function() {
            return _this.emit("select", archiveListItem);
          });
        };
      })(this));
      this.archives.on("child/remove", (function(_this) {
        return function(item) {};
      })(this));
      this.scrollChecker = new ScrollChecker(this.node);
      this.scrollChecker.on("scrollBottom", (function(_this) {
        return function() {
          return _this.more();
        };
      })(this));
    }

    ArchiveList.prototype.render = function() {
      if (!this.currentList) {
        return;
      }
      if (this.sort == null) {
        this.sort = "latest";
      }
      if (this.sort === "latest") {
        this.VM.orderName = "Latest";
        return this.VM.orderIcon = "fa-caret-up";
      } else {
        this.VM.orderName = "Oldest";
        return this.VM.orderIcon = "fa-caret-down";
      }
    };

    ArchiveList.prototype.load = function(list) {
      if (this.currentList) {
        this.currentList.stopListenBy(this);
      }
      this.currentList = list;
      this.currentList.listenBy(this, "add", this.prependArchive);
      this.currentList.listenBy(this, "remove", this.removeArchive);
      this.sort = (App.userConfig.get("listOrder/" + this.currentList.name)) || "latest";
      this.render();
      this.archives.length = 0;
      this.noMore = false;
      this.UI.loadingHint.hide();
      return this.more();
    };

    ArchiveList.prototype.onClickReorder = function() {
      if (!this.currentList) {
        return;
      }
      if (this.sort == null) {
        this.sort = "latest";
      }
      if (this.sort === "latest") {
        App.userConfig.set("listOrder/" + this.currentList.name, "oldest");
      } else {
        App.userConfig.set("listOrder/" + this.currentList.name, "latest");
      }
      return this.load(this.currentList);
    };

    ArchiveList.prototype.more = function() {
      var count, item, lastGuid, list, splitter, _i, _len, _ref;
      if (this.noMore) {
        return;
      }
      count = 20;
      list = this.currentList;
      this.UI.loadingHint.show();
      _ref = this.archives;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        item = _ref[_i];
        if (item.archive.listName === this.currentList.name) {
          lastGuid = item.guid;
        }
      }
      splitter = lastGuid || null;
      return this.currentList.getArchives({
        splitter: splitter,
        count: count,
        sort: this.sort
      }, (function(_this) {
        return function(err, archives) {
          var archive, _j, _len1;
          if (_this.currentList !== list) {
            return;
          }
          _this.UI.loadingHint.hide();
          for (_j = 0, _len1 = archives.length; _j < _len1; _j++) {
            archive = archives[_j];
            _this.archives.push(new ArchiveListItem(archive));
          }
          if (archives.length !== count) {
            return _this.noMore = true;
          }
        };
      })(this));
    };

    ArchiveList.prototype.prependArchive = function(archive) {
      var item, _i, _len, _ref;
      _ref = this.archives;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        item = _ref[_i];
        if (item.archive.guid === archive.guid) {
          if (item.isDone) {
            item.isDone = false;
            item.render();
          }
          return;
        }
      }
      this.emit("archive");
      return this.archives.unshift(new ArchiveListItem(archive));
    };

    ArchiveList.prototype.removeArchive = function(archive) {
      var index, item, _i, _len, _ref;
      _ref = this.archives;
      for (index = _i = 0, _len = _ref.length; _i < _len; index = ++_i) {
        item = _ref[index];
        if (item.archive.guid === archive.guid) {
          if (!item.isDone) {
            item.isDone = true;
            item.render();
            return;
          }
        }
      }
    };

    ArchiveList.prototype.onClickMoreButton = function() {
      return this.more();
    };

    return ArchiveList;

  })(Leaf.Widget);

  tm.use("view/listScene/listSceneArchiveListItem");

  ArchiveListItem = (function(_super) {
    __extends(ArchiveListItem, _super);

    function ArchiveListItem(archive) {
      this.archive = archive;
      ArchiveListItem.__super__.constructor.call(this, App.templates.view.listScene.listSceneArchiveListItem);
      this.render();
      this.isDone = false;
    }

    ArchiveListItem.prototype.onClickNode = function() {
      return this.select();
    };

    ArchiveListItem.prototype.select = function() {
      this.emit("select", this);
      return this.node$.addClass("select");
    };

    ArchiveListItem.prototype.deselect = function() {
      return this.node$.removeClass("select");
    };

    ArchiveListItem.prototype.render = function() {
      this.UI.title$.text(this.archive.title);
      this.UI.content$.text(this.genPreview(this.archive.content));
      if (!this.isDone) {
        return this.node$.removeClass("clear");
      } else {
        return this.node$.addClass("clear");
      }
    };

    ArchiveListItem.prototype.markAsDone = function() {
      if (this.isDone) {
        return;
      }
      return this.archive.changeList(null, (function(_this) {
        return function(err) {
          _this.isDone = true;
          return _this.render();
        };
      })(this));
    };

    ArchiveListItem.prototype.markAsUndone = function() {
      if (!this.isDone) {
        return;
      }
      return this.archive.changeList(this.listName, (function(_this) {
        return function(err) {
          _this.isDone = false;
          return _this.render();
        };
      })(this));
    };

    ArchiveListItem.prototype.onClickDone = function(e) {
      if (e) {
        e.preventDefault();
        e.stopImmediatePropagation();
      }
      if (this.isDone) {
        return this.markAsUndone();
      } else {
        return this.markAsDone();
      }
    };

    ArchiveListItem.prototype.genPreview = function(content) {
      var container, maxLength, result;
      container = document.createElement("div");
      container.innerHTML = content;
      maxLength = 50;
      result = $(container).text().trim().substring(0, maxLength);
      if (result.length === maxLength) {
        result += "...";
      } else if (result.length === 0) {
        result = "( empty )";
      }
      return result;
    };

    return ArchiveListItem;

  })(Leaf.Widget);

  tm.use("view/listScene/archiveDisplayer");

  ListArchiveDisplayer = (function(_super) {
    __extends(ListArchiveDisplayer, _super);

    function ListArchiveDisplayer(context) {
      this.context = context;
      this.archiveHelper = new ArchiveHelper(this);
      ListArchiveDisplayer.__super__.constructor.call(this, App.templates.view.listScene.archiveDisplayer);
      this.node$.addClass("no-article");
    }

    ListArchiveDisplayer.prototype.display = function(archive) {
      this.node$.removeClass("no-article");
      this.setArchive(archive);
      this.node.scrollTop = 0;
      return this.render();
    };

    return ListArchiveDisplayer;

  })(ArchiveDisplayer);

  Flag = require("/component/flag");

  tm.use("view/listScene/archiveHelper");

  ArchiveHelper = (function(_super) {
    __extends(ArchiveHelper, _super);

    function ArchiveHelper(archiveDisplayer) {
      this.archiveDisplayer = archiveDisplayer;
      ArchiveHelper.__super__.constructor.call(this, App.templates.view.listScene.archiveHelper);
      this.context = this.archiveDisplayer.context;
      this.showOptionFlag = new Flag().attach(this.VM, "showOption").unset();
    }

    ArchiveHelper.prototype.render = function() {
      var archive;
      archive = this.archiveDisplayer.archive;
      return this.Data.cleared = !archive.listName;
    };

    ArchiveHelper.prototype.onClickExpandOption = function() {
      return this.showOptionFlag.toggle();
    };

    ArchiveHelper.prototype.onClickClear = function() {
      if (this.archiveDisplayer.archive.listName === this.context.archives.currentList.name) {
        this.archiveDisplayer.onClickReadLater();
      }
      if (this.onClickNext()) {

      } else if (this.onClickPrevious()) {

      }
    };

    ArchiveHelper.prototype.goTop = function() {
      return this.archiveDisplayer.UI.scrollable.scrollTop = 0;
    };

    ArchiveHelper.prototype.goBottom = function() {
      var scrollable;
      scrollable = this.archiveDisplayer.UI.scrollable;
      return scrollable.scrollTop = scrollable.scrollHeight;
    };

    ArchiveHelper.prototype.isTop = function() {
      return this.archiveDisplayer.UI.scrollable.scrollTop < 2;
    };

    ArchiveHelper.prototype.isBottom = function() {
      return true;
    };

    ArchiveHelper.prototype.onClickGoBottom = function() {
      console.log("go bottom???");
      return this.goBottom();
    };

    ArchiveHelper.prototype.onClickNext = function() {
      var archives, index, item, _i, _len;
      if (!this.isBottom()) {
        this.goBottom();
      }
      archives = this.context.archives.archives;
      for (index = _i = 0, _len = archives.length; _i < _len; index = ++_i) {
        item = archives[index];
        if (item.archive === this.archiveDisplayer.archive) {
          if (archives[index + 1]) {
            archives[index + 1].select();
            this.goTop();
          }
          return true;
        }
      }
      return false;
    };

    ArchiveHelper.prototype.onClickPrevious = function() {
      var archives, index, item, _i, _len;
      if (!this.isTop()) {
        this.goTop();
        return;
      }
      archives = this.context.archives.archives;
      for (index = _i = 0, _len = archives.length; _i < _len; index = ++_i) {
        item = archives[index];
        if (item.archive === this.archiveDisplayer.archive) {
          if (archives[index - 1]) {
            archives[index - 1].select();
            this.goTop();
          }
          return true;
        }
      }
      return false;
    };

    return ArchiveHelper;

  })(Leaf.Widget);

  module.exports = ListScene;

}).call(this);
