// Generated by CoffeeScript 1.8.0
(function() {
  var App, ArchiveDisplayer, ArchiveDisplayerListSelector, ArchiveDisplayerListSelectorItem, ContentImage, Model, Popup, RichContent, SmartImage, i18n, moment, tm,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  i18n = require("/common/i18n");

  moment = require("/component/moment");

  App = require("/app");

  Model = App.Model;

  SmartImage = require("/widget/smartImage");

  ContentImage = require("/widget/contentImage");

  tm = require("/common/templateManager");

  tm.use("view/base/archiveDisplayer");

  ArchiveDisplayer = (function(_super) {
    __extends(ArchiveDisplayer, _super);

    function ArchiveDisplayer(template) {
      this.include(ContentImage);
      this.include(SmartImage);
      ArchiveDisplayer.__super__.constructor.call(this, template || App.templates.view.base.archiveDisplayer);
      this.useDisplayContent = true;
    }

    ArchiveDisplayer.prototype.setArchive = function(archive) {
      if (this.archive) {
        this.archive.stopListenBy(this);
        this.stopBubble(this.archive);
      }
      this.archive = archive;
      this.bubble(this.archive, "change");
      this.archive.listenBy(this, "change", this.render);
      if (this.richContent) {
        this.richContent.destroy();
      }
      this.richContent = new RichContent(this.archive);
      return this.render();
    };

    ArchiveDisplayer.prototype.unsetArchive = function() {
      var _ref;
      if (this.archive) {
        this.archive.stopListenBy(this);
      }
      if ((_ref = this.richContent) != null) {
        _ref.destroy();
      }
      this.richContent = null;
      return this.archive = null;
    };

    ArchiveDisplayer.prototype.focus = function() {
      return this.node$.addClass("focus");
    };

    ArchiveDisplayer.prototype.blur = function() {
      return this.node$.removeClass("focus");
    };

    ArchiveDisplayer.prototype._renderShareInfo = function(profile, howmany) {
      var html, words;
      if (howmany === 0) {
        this.UI.shareInfo$.text("");
        return true;
      }
      if (!profile) {
        this.UI.shareInfo$.text(i18n.thisManyPeopleHasShareIt_i(howmany));
        return true;
      }
      if (profile) {
        html = "<img src='http://www.gravatar.com/avatar/" + profile.hash + "?s=12&d=identicon'></img>";
        if (howmany > 1) {
          words = i18n.andThisMorePeopleHasShareIt_i(howmany - 1);
        } else {
          words = profile.nickname + " " + i18n.sharesIt();
        }
        return this.UI.shareInfo$.html(html + words);
      }
    };

    ArchiveDisplayer.prototype.render = function() {
      var maybeList, originalLink, profile, shareRecords, toDisplay;
      this.UI.title$.text(this.archive.title);
      if (this.UI.avatar && this.archive.author && this.archive.author.avatar) {
        this.UI.avatar$.addClass("show");
        this.UI.avatar.src = this.archive.author.avatar;
      } else {
        this.UI.avatar$.removeClass("show");
      }
      if (this.archive.originalLink) {
        this.UI.title$.attr("href", this.archive.originalLink);
      }
      if (this.archive.like) {
        this.UI.like$.addClass("active");
      } else {
        this.UI.like$.removeClass("active");
      }
      maybeList = this.archive.listName || this.maybeList || App.userConfig.get("" + this.archive.sourceGuid + "/maybeList") || "read later";
      this.VM.listName = maybeList;
      if (this.archive.listName === maybeList) {
        this.UI.readLater$.addClass("active");
      } else {
        this.UI.readLater$.removeClass("active");
      }
      if (this.archive.listName) {
        this.VM.listText = "list (" + this.archive.listName + ")";
      } else {
        this.VM.listText = "list";
      }
      if (this.archive.createDate) {
        this.UI.date$.text(moment(this.archive.createDate).format(i18n.fullDateFormatString()));
      }
      if (this.archive.share) {
        this.UI.share$.addClass("active");
      } else {
        this.UI.share$.removeClass("active");
      }
      shareRecords = this.archive.meta.shareRecords;
      if (shareRecords) {
        profile = this.archive.getFirstValidProfile();
        this._renderShareInfo(profile, shareRecords.length);
      }
      this.UI.sourceName$.text(this.archive.sourceName);
      originalLink = this.archive.originalLink || "";
      if (this.useDisplayContent) {
        toDisplay = this.archive.displayContent || this.archive.content;
      } else {
        toDisplay = this.archive.content;
      }
      if (this.UI.content.children[0] !== this.richContent.container) {
        this.UI.content.innerHTML = "";
        return this.UI.content.appendChild(this.richContent.container);
      }
    };

    ArchiveDisplayer.prototype.onClickShare = function() {
      if (!this.archive.share) {
        console.log(this.archive);
        return this.archive.markAsShare((function(_this) {
          return function(err) {
            return _this.render();
          };
        })(this));
      } else {
        return this.archive.markAsUnshare((function(_this) {
          return function(err) {
            return _this.render();
          };
        })(this));
      }
    };

    ArchiveDisplayer.prototype.onClickReadLater = function() {
      var maybeList;
      maybeList = App.userConfig.get("" + this.archive.sourceGuid + "/maybeList") || "read later";
      if (!this.archive.listName) {
        return this.archive.changeList(maybeList, (function(_this) {
          return function(err) {
            if (err) {
              console.error(err);
            }
            return _this.render();
          };
        })(this));
      } else {
        return this.archive.changeList(null, (function(_this) {
          return function(err) {
            if (err) {
              console.error(err);
            }
            return _this.render();
          };
        })(this));
      }
    };

    ArchiveDisplayer.prototype.onClickLike = function() {
      if (!this.archive.like) {
        return this.archive.likeArchive((function(_this) {
          return function(err) {
            if (err) {
              console.error(err);
            }
            return _this.render();
          };
        })(this));
      } else {
        return this.archive.unlikeArchive((function(_this) {
          return function(err) {
            if (err) {
              console.error(err);
            }
            return _this.render();
          };
        })(this));
      }
    };

    ArchiveDisplayer.prototype.onClickList = function(e) {
      if (!this.listSelector) {
        this.listSelector = new ArchiveDisplayerListSelector();
        this.listSelector.listenBy(this, "select", (function(_this) {
          return function(listModel) {
            return _this.archive.changeList(listModel.name, function(err) {
              App.userConfig.set("" + _this.archive.sourceGuid + "/maybeList", listModel.name);
              _this.listSelector.active(listModel.name);
              _this.listSelector.hide();
              return _this.render();
            });
          };
        })(this));
      }
      this.listSelector.updateState();
      this.listSelector.show(e);
      if (this.archive.listName) {
        return this.listSelector.active(this.archive.listName);
      }
    };

    ArchiveDisplayer.prototype.markAsLike = function() {
      if (!this.archive.like) {
        return this.archive.likeArchive(function() {
          return this.render();
        });
      }
    };

    ArchiveDisplayer.prototype.markAsUnlike = function() {
      if (!this.archive.like) {
        return this.archive.unlikeArchive((function(_this) {
          return function() {
            return _this.render();
          };
        })(this));
      }
    };

    ArchiveDisplayer.prototype.destroy = function() {
      var _ref;
      ArchiveDisplayer.__super__.destroy.call(this);
      if ((_ref = this.richContent) != null) {
        _ref.destroy();
      }
      return this.unsetArchive();
    };

    return ArchiveDisplayer;

  })(Leaf.Widget);

  Popup = require("/view/base/popup");

  tm.use("view/base/archiveDisplayerListSelector");

  ArchiveDisplayerListSelector = (function(_super) {
    __extends(ArchiveDisplayerListSelector, _super);

    function ArchiveDisplayerListSelector() {
      ArchiveDisplayerListSelector.__super__.constructor.call(this, App.templates.view.base.archiveDisplayerListSelector);
      this.lists = Leaf.Widget.makeList(this.UI.lists);
      this.lists.on("child/add", (function(_this) {
        return function(item) {
          return item.listenBy(_this, "select", _this.select);
        };
      })(this));
      this.lists.on("child/remove", (function(_this) {
        return function(item) {
          return item.stopListenBy(_this);
        };
      })(this));
    }

    ArchiveDisplayerListSelector.prototype.updateState = function() {
      var list, _i, _len, _ref, _results;
      this.lists.length = 0;
      _ref = Model.ArchiveList.lists.models;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        list = _ref[_i];
        _results.push(this.lists.push(new ArchiveDisplayerListSelectorItem(list)));
      }
      return _results;
    };

    ArchiveDisplayerListSelector.prototype.show = function(e) {
      var height, left, top;
      ArchiveDisplayerListSelector.__super__.show.call(this);
      if (!e) {
        return;
      }
      if (Leaf.Util.isMobile()) {
        return;
      }
      this.node$.width(300);
      height = this.node$.height();
      top = e.clientY + 15 - height;
      left = e.clientX - 10;
      top = top > 0 && top || 0;
      left = left > 0 && left || 0;
      return this.node$.css({
        position: "absolute",
        top: top,
        left: left
      });
    };

    ArchiveDisplayerListSelector.prototype.select = function(item) {
      return this.emit("select", item.list);
    };

    ArchiveDisplayerListSelector.prototype.active = function(name) {
      var item, _i, _len, _ref, _results;
      if (!name) {
        return;
      }
      _ref = this.lists;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        item = _ref[_i];
        item.deactive();
        if (item.list.name === name) {
          _results.push(item.active());
        } else {
          _results.push(void 0);
        }
      }
      return _results;
    };

    ArchiveDisplayerListSelector.prototype.onClickCloseButton = function() {
      return this.hide();
    };

    return ArchiveDisplayerListSelector;

  })(Popup);

  RichContent = (function(_super) {
    __extends(RichContent, _super);

    function RichContent(archive) {
      var el, img, imgs, insideLink, link, links, p, params, si, src, _base, _i, _j, _k, _len, _len1, _len2, _ref;
      this.archive = archive;
      this.container = document.createElement("div");
      this.container.classList.add("rich-content");
      if ((_base = this.archive).sanitizedContent == null) {
        _base.sanitizedContent = sanitizer.sanitize(this.archive.displayContent || this.archive.content);
      }
      this.container.innerHTML = this.archive.sanitizedContent;
      this.images = [];
      imgs = [];
      links = [];
      this.useResourceProxy = (App.userConfig.get("enableResourceProxy/" + this.archive.sourceGuid)) && true || false;
      _ref = this.container.querySelectorAll("img,a");
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        el = _ref[_i];
        if (el.tagName.toLowerCase() === "img") {
          insideLink = false;
          p = el.parentElement;
          while (p) {
            if (p.tagName === "A") {
              insideLink = true;
            }
            p = p.parentElement;
          }
          if (!insideLink) {
            imgs.push(el);
          }
        } else if (el.tagName === "A") {
          links.push(el);
        }
      }
      for (_j = 0, _len1 = imgs.length; _j < _len1; _j++) {
        img = imgs[_j];
        src = this.decorateImageUrl(img.getAttribute("src") || img.getAttribute("data-raw-src"));
        params = {
          thumbSrc: this.decorateImageUrl(img.getAttribute("data-thumbnail-src")),
          originalSrc: this.decorateImageUrl(img.getAttribute("data-raw-src") || src),
          mediumSrc: this.decorateImageUrl(img.getAttribute("data-medium-src"))
        };
        si = new ContentImage(img, params);
        si.ownerContent = this;
        si.index = this.images.length;
        this.images.push(si);
        if (img.parentElement) {
          img.parentElement.replaceChild(si.node, img);
        }
        img.removeAttribute("src");
        si.on("display", (function(_this) {
          return function(si) {
            App.imageDisplayer.show();
            return App.imageDisplayer.setSrcs(_this.images.map(function(si) {
              return si.getOriginalSrc();
            }), si.index);
          };
        })(this));
      }
      for (_k = 0, _len2 = links.length; _k < _len2; _k++) {
        link = links[_k];
        link.setAttribute("target", "_blank");
      }
    }

    RichContent.prototype.decorateImageUrl = function(url) {
      if (this.useResourceProxy) {
        return "/remoteResource?url=" + (encodeURIComponent(url)) + "&referer=" + this.archive.originalLink;
      }
      return url;
    };

    RichContent.prototype.destroy = function() {
      var si, _i, _len, _ref;
      _ref = this.images;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        si = _ref[_i];
        si.destroy();
      }
      return this.container = null;
    };

    return RichContent;

  })(Leaf.EventEmitter);

  ArchiveDisplayerListSelectorItem = (function(_super) {
    __extends(ArchiveDisplayerListSelectorItem, _super);

    function ArchiveDisplayerListSelectorItem(list) {
      this.list = list;
      ArchiveDisplayerListSelectorItem.__super__.constructor.call(this, "<li data-text='name'></li>");
      this.VM.name = this.list.name;
    }

    ArchiveDisplayerListSelectorItem.prototype.onClickNode = function() {
      return this.emit("select", this);
    };

    ArchiveDisplayerListSelectorItem.prototype.active = function() {
      return this.VM.name = "(current) " + this.list.name;
    };

    ArchiveDisplayerListSelectorItem.prototype.deactive = function() {
      return this.VM.name = this.list.name;
    };

    return ArchiveDisplayerListSelectorItem;

  })(Leaf.Widget);

  module.exports = ArchiveDisplayer;

}).call(this);
