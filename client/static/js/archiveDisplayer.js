// Generated by CoffeeScript 1.8.0
(function() {
  var App, ArchiveDisplayer, ArchiveDisplayerListSelector, ArchiveDisplayerListSelectorItem, Model, Popup, i18n, moment,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  i18n = require("i18n");

  moment = require("lib/moment");

  App = require("app");

  Model = require("model");

  ArchiveDisplayer = (function(_super) {
    __extends(ArchiveDisplayer, _super);

    function ArchiveDisplayer(template) {
      ArchiveDisplayer.__super__.constructor.call(this, template);
      this.useDisplayContent = true;
    }

    ArchiveDisplayer.prototype.setArchive = function(archive) {
      if (this.archive) {
        this.archive.stopListenBy(this);
      }
      this.archive = archive;
      this.archive.listenBy(this, "change", this.render);
      return this.render();
    };

    ArchiveDisplayer.prototype._renderShareInfo = function(profile, howmany) {
      var html, words;
      if (howmany === 0) {
        this.UI.shareInfo$.text("");
        return true;
      }
      if (!profile) {
        this.UI.shareInfo$.text(i18n.thisManyPeopleHasShareIt_i(howmany));
        return true;
      }
      if (profile) {
        html = "<img src='http://www.gravatar.com/avatar/" + profile.hash + "?s=12&d=identicon'></img>";
        if (howmany > 1) {
          words = i18n.andThisMorePeopleHasShareIt_i(howmany - 1);
        } else {
          words = profile.nickname + " " + i18n.sharesIt();
        }
        return this.UI.shareInfo$.html(html + words);
      }
    };

    ArchiveDisplayer.prototype.render = function() {
      var content, maybeList, originalLink, profile, shareRecords, toDisplay;
      this.UI.title$.text(this.archive.title);
      if (this.archive.originalLink) {
        this.UI.title$.attr("href", this.archive.originalLink);
      }
      if (this.archive.like) {
        this.UI.like$.addClass("active");
      } else {
        this.UI.like$.removeClass("active");
      }
      maybeList = App.userConfig.get("" + this.archive.sourceGuid + "/maybeList") || "read later";
      this.UI.readLater$.text(maybeList);
      if (this.archive.listName === maybeList) {
        this.UI.readLater$.addClass("active");
      } else {
        this.UI.readLater$.removeClass("active");
      }
      if (this.archive.listName) {
        this.renderData.listText = "list (" + this.archive.listName + ")";
      } else {
        this.renderData.listText = "list";
      }
      if (this.archive.createDate) {
        this.UI.date$.text(moment(this.archive.createDate).format(i18n.fullDateFormatString()));
      }
      if (this.archive.share) {
        this.UI.share$.addClass("active");
      } else {
        this.UI.share$.removeClass("active");
      }
      shareRecords = this.archive.meta.shareRecords;
      if (shareRecords) {
        profile = this.archive.getFirstValidProfile();
        this._renderShareInfo(profile, shareRecords.length);
      }
      this.UI.sourceName$.text(this.archive.sourceName);
      originalLink = this.archive.originalLink || "";
      if (this.useDisplayContent) {
        toDisplay = this.archive.displayContent || this.archive.content;
      } else {
        toDisplay = this.archive.content;
      }
      if (this.currentContent !== toDisplay) {
        this.currentContent = toDisplay;
        if (!this.currentContent) {
          this.UI.content$.text("");
          return;
        }
        if (App.userConfig.get("enableResourceProxy")) {
          if (!App.userConfig.get("useResourceProxyByDefault")) {
            this.UI.content$.html(sanitizer.sanitize(toDisplay));
            this.UI.content$.find("img").each(function() {
              this.useProxy = false;
              return this.onerror = (function(_this) {
                return function() {
                  var url;
                  if (_this.userProxy) {
                    return;
                  }
                  _this.useProxy = true;
                  url = _this.getAttribute("src");
                  if (url.indexOf("/remoteResource") >= 0) {
                    return;
                  }
                  if (url.indexOf("file://") >= 0) {
                    return;
                  }
                  return $(_this).attr("src", "/remoteResource?url=" + (encodeURIComponent(url)) + "&referer=" + originalLink);
                };
              })(this);
            });
          } else {
            content = document.createElement("div");
            content.innerHTML = sanitizer.sanitize(toDisplay);
            $(content).find("img").each(function() {
              var url;
              url = this.getAttribute("src");
              return $(this).attr("src", "/remoteResource?url=" + (encodeURIComponent(url)) + "&referer=" + originalLink);
            });
            this.UI.content$.html(content.innerHTML);
          }
        } else {
          this.UI.content$.html(sanitizer.sanitize(toDisplay));
        }
        return this.UI.content$.find("a").each(function() {
          return this.setAttribute("target", "_blank");
        });
      }
    };

    ArchiveDisplayer.prototype.onClickShare = function() {
      if (!this.archive.share) {
        console.log(this.archive);
        return this.archive.markAsShare((function(_this) {
          return function(err) {
            return _this.render();
          };
        })(this));
      } else {
        return this.archive.markAsUnshare((function(_this) {
          return function(err) {
            return _this.render();
          };
        })(this));
      }
    };

    ArchiveDisplayer.prototype.onClickReadLater = function() {
      var maybeList;
      maybeList = App.userConfig.get("" + this.archive.sourceGuid + "/maybeList") || "read later";
      if (this.archive.listName !== maybeList) {
        return this.archive.changeList(maybeList, (function(_this) {
          return function(err) {
            if (err) {
              console.error(err);
            }
            return _this.render();
          };
        })(this));
      } else {
        return this.archive.changeList(null, (function(_this) {
          return function(err) {
            if (err) {
              console.error(err);
            }
            return _this.render();
          };
        })(this));
      }
    };

    ArchiveDisplayer.prototype.onClickLike = function() {
      if (!this.archive.like) {
        return this.archive.likeArchive((function(_this) {
          return function(err) {
            if (err) {
              console.error(err);
            }
            return _this.render();
          };
        })(this));
      } else {
        return this.archive.unlikeArchive((function(_this) {
          return function(err) {
            if (err) {
              console.error(err);
            }
            return _this.render();
          };
        })(this));
      }
    };

    ArchiveDisplayer.prototype.onClickList = function(e) {
      if (!this.listSelector) {
        this.listSelector = new ArchiveDisplayerListSelector();
        this.listSelector.listenBy(this, "select", (function(_this) {
          return function(listModel) {
            return _this.archive.changeList(listModel.name, function(err) {
              App.userConfig.set("" + _this.archive.sourceGuid + "/maybeList", listModel.name);
              _this.listSelector.active(listModel.name);
              _this.listSelector.hide();
              return _this.render();
            });
          };
        })(this));
      }
      this.listSelector.updateState();
      this.listSelector.show(e);
      if (this.archive.listName) {
        return this.listSelector.active(this.archive.listName);
      }
    };

    ArchiveDisplayer.prototype.markAsLike = function() {
      if (!this.archive.like) {
        return this.archive.likeArchive(function() {
          return this.render();
        });
      }
    };

    ArchiveDisplayer.prototype.markAsUnlike = function() {
      if (!this.archive.like) {
        return this.archive.unlikeArchive((function(_this) {
          return function() {
            return _this.render();
          };
        })(this));
      }
    };

    return ArchiveDisplayer;

  })(Leaf.Widget);

  Popup = require("widget/popup");

  ArchiveDisplayerListSelector = (function(_super) {
    __extends(ArchiveDisplayerListSelector, _super);

    function ArchiveDisplayerListSelector() {
      ArchiveDisplayerListSelector.__super__.constructor.call(this, App.templates["archive-displayer-list-selector"]);
      this.lists = Leaf.Widget.makeList(this.UI.lists);
      this.lists.on("child/add", (function(_this) {
        return function(item) {
          return item.listenBy(_this, "select", _this.select);
        };
      })(this));
      this.lists.on("child/remove", (function(_this) {
        return function(item) {
          return item.stopListenBy(_this);
        };
      })(this));
    }

    ArchiveDisplayerListSelector.prototype.updateState = function() {
      var list, _i, _len, _ref, _results;
      this.lists.length = 0;
      _ref = Model.ArchiveList.lists.models;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        list = _ref[_i];
        _results.push(this.lists.push(new ArchiveDisplayerListSelectorItem(list)));
      }
      return _results;
    };

    ArchiveDisplayerListSelector.prototype.show = function(e) {
      var height;
      ArchiveDisplayerListSelector.__super__.show.call(this);
      if (!e) {
        return;
      }
      if (Leaf.Util.isMobile()) {
        return;
      }
      this.node$.width(300);
      height = this.node$.height();
      return this.node$.css({
        position: "absolute",
        top: e.clientY + 15 - height,
        left: e.clientX - 10
      });
    };

    ArchiveDisplayerListSelector.prototype.select = function(item) {
      return this.emit("select", item.list);
    };

    ArchiveDisplayerListSelector.prototype.active = function(name) {
      var item, _i, _len, _ref, _results;
      if (!name) {
        return;
      }
      _ref = this.lists;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        item = _ref[_i];
        item.deactive();
        if (item.list.name === name) {
          _results.push(item.active());
        } else {
          _results.push(void 0);
        }
      }
      return _results;
    };

    ArchiveDisplayerListSelector.prototype.onClickCloseButton = function() {
      return this.hide();
    };

    return ArchiveDisplayerListSelector;

  })(Popup);

  ArchiveDisplayerListSelectorItem = (function(_super) {
    __extends(ArchiveDisplayerListSelectorItem, _super);

    function ArchiveDisplayerListSelectorItem(list) {
      this.list = list;
      ArchiveDisplayerListSelectorItem.__super__.constructor.call(this, "<li data-text='name'></li>");
      this.renderData.name = this.list.name;
    }

    ArchiveDisplayerListSelectorItem.prototype.onClickNode = function() {
      return this.emit("select", this);
    };

    ArchiveDisplayerListSelectorItem.prototype.active = function() {
      return this.renderData.name = "(current) " + this.list.name;
    };

    ArchiveDisplayerListSelectorItem.prototype.deactive = function() {
      return this.renderData.name = this.list.name;
    };

    return ArchiveDisplayerListSelectorItem;

  })(Leaf.Widget);

  module.exports = ArchiveDisplayer;

}).call(this);
