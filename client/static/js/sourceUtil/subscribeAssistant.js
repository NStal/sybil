// Generated by CoffeeScript 1.8.0
(function() {
  var AdapterTerminal, App, CubeLoadingHint, HintStack, SubscribeAssistant, tm,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  App = require("/app");

  AdapterTerminal = require("./adapterTerminal");

  HintStack = require("/hintStack");

  CubeLoadingHint = require("/widget/cubeLoadingHint");

  tm = require("/templateManager");

  tm.use("sourceUtil/subscribeAssistant");

  SubscribeAssistant = (function(_super) {
    __extends(SubscribeAssistant, _super);

    function SubscribeAssistant(uri) {
      this.uri = uri;
      this.include(CubeLoadingHint);
      SubscribeAssistant.__super__.constructor.call(this, App.templates.sourceUtil.subscribeAssistant);
      this.show();
      this.terminals = [];
      this.setHint("Try detect any possible source from the given url " + this.uri);
      App.messageCenter.invoke("detectStream", this.uri, (function(_this) {
        return function(err, stream) {
          console.debug("get stream", err, stream);
          if (err) {
            _this.emit("error", err);
            return;
          }
          stream.on("data", function(candidate) {
            console.debug("get candidate", candidate);
            return _this.spawnAdapterTerminal(candidate);
          });
          return stream.on("end", function() {
            console.debug("end stream");
            console.debug(_this.terminals.length, _this.terminals.map(function(item) {
              return item.candidate;
            }));
            if (_this.terminals.length === 0) {
              _this.setHint("No source available detected from the url " + _this.uri);
              _this.emit("none");
            } else if (_this.terminals.length === 1) {
              _this.setHint("One source detected auto accept.");
              _this.terminals[0].accept();
            } else {
              _this.setHint("Some source detected");
            }
            return _this.delayHide();
          });
        };
      })(this));
    }

    SubscribeAssistant.prototype.setHint = function(content) {
      this.attract();
      this.UI.loadingHint$.hide();
      return this.UI.hint$.text(content);
    };

    SubscribeAssistant.prototype.delayHide = function(time) {
      var hideDelayTime;
      hideDelayTime = time || 1000 * 3;
      return setTimeout(((function(_this) {
        return function() {
          return _this.hide();
        };
      })(this)), hideDelayTime);
    };

    SubscribeAssistant.prototype.spawnAdapterTerminal = function(candidate) {
      var terminal;
      terminal = new AdapterTerminal(candidate);
      this.terminals.push(terminal);
      return terminal.once("complete", (function(_this) {
        return function() {
          var _i, _len, _ref;
          _ref = _this.terminals;
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            terminal = _ref[_i];
            if (!terminal.isDone) {
              return;
            }
          }
          return _this.emit("done");
        };
      })(this));
    };

    return SubscribeAssistant;

  })(HintStack.HintStackItem);

  module.exports = SubscribeAssistant;

}).call(this);
